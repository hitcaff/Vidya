<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vidya ‚Äî Your Teacher</title>
  <style>
    /* ----------------------------------------------------------------
       Base reset & fonts
    ---------------------------------------------------------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #0f1923;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 24px 16px;
    }

    /* ----------------------------------------------------------------
       Header
    ---------------------------------------------------------------- */
    .header {
      text-align: center;
      margin-bottom: 28px;
    }
    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #60aaff;
      letter-spacing: 2px;
    }
    .header p {
      font-size: 0.95rem;
      color: #8899aa;
      margin-top: 4px;
    }

    /* ----------------------------------------------------------------
       IMAGE CARD AREA ‚Äî reserved from Phase 1.
       In Phase 1 this is blank/hidden.
       In Phase 4 (Visual Learning), the WebSocket handler will
       swap the image shown here based on [SHOW:asset_key] signals
       from the bot.

       DO NOT remove or restructure this section ‚Äî it must exist
       before the frontend is built out.
    ---------------------------------------------------------------- */
    .image-card {
      width: 100%;
      max-width: 480px;
      aspect-ratio: 4 / 3;
      background: #1a2535;
      border: 2px dashed #2a3a50;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 28px;
      transition: all 0.4s ease;
      overflow: hidden;
      position: relative;
    }

    /* When an image is active (Phase 4), the dashed border disappears */
    .image-card.active {
      border: 2px solid #60aaff;
      background: #0d1520;
    }

    .image-card img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 20px;
      display: none;          /* Hidden in Phase 1 ‚Äî shown in Phase 4 */
    }
    .image-card.active img {
      display: block;
    }

    /* Placeholder text shown in Phase 1 while image area is empty */
    .image-card .placeholder {
      text-align: center;
      color: #2a3a50;
      pointer-events: none;
    }
    .image-card .placeholder .icon {
      font-size: 4rem;
      display: block;
      margin-bottom: 12px;
    }
    .image-card .placeholder p {
      font-size: 0.85rem;
    }
    /* Hide placeholder when image is active */
    .image-card.active .placeholder {
      display: none;
    }

    /* ----------------------------------------------------------------
       Status indicator ‚Äî shows what Vidya is doing
    ---------------------------------------------------------------- */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
      background: #1a2535;
      padding: 10px 20px;
      border-radius: 30px;
      min-width: 240px;
      justify-content: center;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #444;
      flex-shrink: 0;
      transition: background 0.3s;
    }
    .status-dot.connecting  { background: #f59e0b; animation: pulse 1.2s infinite; }
    .status-dot.listening   { background: #22c55e; animation: pulse 1s infinite; }
    .status-dot.speaking    { background: #60aaff; animation: pulse 0.8s infinite; }
    .status-dot.connected   { background: #22c55e; }
    .status-dot.error       { background: #ef4444; }

    .status-text {
      font-size: 0.9rem;
      color: #aabbcc;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.3; }
    }

    /* ----------------------------------------------------------------
       Main action button
    ---------------------------------------------------------------- */
    .btn-start {
      width: 100%;
      max-width: 320px;
      padding: 18px 0;
      font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    .btn-start.start {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #fff;
      box-shadow: 0 4px 24px rgba(79, 70, 229, 0.4);
    }
    .btn-start.start:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 32px rgba(79, 70, 229, 0.55);
    }

    .btn-start.stop {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: #fff;
      box-shadow: 0 4px 24px rgba(220, 38, 38, 0.35);
    }
    .btn-start.stop:hover {
      transform: translateY(-2px);
    }

    .btn-start:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Mic icon inside button */
    .btn-start .btn-icon { margin-right: 10px; }

    /* ----------------------------------------------------------------
       Transcript area ‚Äî shows what was said (helpful for debugging)
    ---------------------------------------------------------------- */
    .transcript {
      width: 100%;
      max-width: 480px;
      background: #1a2535;
      border-radius: 14px;
      padding: 16px;
      margin-top: 8px;
      min-height: 80px;
      max-height: 200px;
      overflow-y: auto;
    }
    .transcript-line {
      font-size: 0.85rem;
      line-height: 1.5;
      margin-bottom: 6px;
      padding: 6px 10px;
      border-radius: 8px;
    }
    .transcript-line.student {
      background: #1e3a5f;
      color: #93c5fd;
      text-align: left;
    }
    .transcript-line.vidya {
      background: #1e3a28;
      color: #86efac;
      text-align: left;
    }
    .transcript-empty {
      color: #2a3a50;
      font-size: 0.85rem;
      text-align: center;
      padding-top: 8px;
    }

    /* ----------------------------------------------------------------
       Footer
    ---------------------------------------------------------------- */
    .footer {
      margin-top: 28px;
      font-size: 0.75rem;
      color: #2a3a50;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h1>üéì VIDYA</h1>
    <p>Your personal teacher ‚Äî speak to start learning</p>
  </div>

  <!-- ================================================================
       IMAGE CARD AREA ‚Äî reserved for Phase 4 Visual Learning.
       In Phase 1 this shows a placeholder.
       In Phase 4 the WebSocket handler will call showImage("letter_A")
       and this card will display the corresponding image.
  ================================================================ -->
  <div class="image-card" id="imageCard">
    <img id="lessonImage" src="" alt="Learning visual" />
    <div class="placeholder">
      <span class="icon">üìö</span>
      <p>Your lesson visuals<br>will appear here</p>
    </div>
  </div>

  <!-- Status bar -->
  <div class="status-bar">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-text" id="statusText">Ready to connect</span>
  </div>

  <!-- Start / Stop button -->
  <button class="btn-start start" id="mainBtn" onclick="toggleSession()">
    <span class="btn-icon">üéôÔ∏è</span> Start Learning with Vidya
  </button>

  <!-- Transcript -->
  <div class="transcript" id="transcript">
    <div class="transcript-empty" id="transcriptEmpty">
      What you and Vidya say will appear here...
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Vidya ‚Äî AI Literacy Bot &nbsp;‚Ä¢&nbsp; Phase 1
  </div>


  <!-- ================================================================
       Daily.co Prebuilt SDK ‚Äî handles WebRTC connection to Daily room
  ================================================================ -->
  <script src="https://unpkg.com/@daily-co/daily-js"></script>

  <script>
    // ----------------------------------------------------------------
    // State
    // ----------------------------------------------------------------
    let callObject = null;
    let isConnected = false;

    // ----------------------------------------------------------------
    // UI helpers
    // ----------------------------------------------------------------
    function setStatus(state, text) {
      const dot  = document.getElementById("statusDot");
      const label = document.getElementById("statusText");
      dot.className = "status-dot " + state;
      label.textContent = text;
    }

    function addTranscript(speaker, text) {
      const container = document.getElementById("transcript");
      const empty = document.getElementById("transcriptEmpty");
      if (empty) empty.remove();

      const line = document.createElement("div");
      line.className = "transcript-line " + speaker;
      line.textContent = (speaker === "vidya" ? "üéì Vidya: " : "üë§ You: ") + text;
      container.appendChild(line);
      container.scrollTop = container.scrollHeight;
    }

    // ----------------------------------------------------------------
    // Visual Learning ‚Äî Phase 4 placeholder functions.
    // These do nothing in Phase 1 but are wired up and ready.
    // In Phase 4, the WebSocket handler will call showImage() and
    // hideImage() based on [SHOW:x] signals from the bot.
    // ----------------------------------------------------------------
    function showImage(assetKey) {
      const card  = document.getElementById("imageCard");
      const img   = document.getElementById("lessonImage");
      // Phase 4: img.src = `/assets/${assetKey}.png`;
      // card.classList.add("active");
      console.log("[Visual] Phase 4 will show:", assetKey);
    }

    function hideImage() {
      const card = document.getElementById("imageCard");
      const img  = document.getElementById("lessonImage");
      card.classList.remove("active");
      img.src = "";
      console.log("[Visual] Image hidden");
    }

    // ----------------------------------------------------------------
    // WebSocket for visual signals ‚Äî Phase 4 placeholder.
    // In Phase 4, connect to FastAPI WebSocket here and call
    // showImage() / hideImage() on incoming messages.
    // ----------------------------------------------------------------
    function connectVisualChannel(sessionId) {
      // Phase 4 implementation:
      // const ws = new WebSocket(`ws://localhost:8000/ws/visual/${sessionId}`);
      // ws.onmessage = (event) => {
      //   const data = JSON.parse(event.data);
      //   if (data.show) showImage(data.show);
      //   if (data.hide) hideImage();
      // };
      console.log("[Visual] Phase 4 WebSocket channel ‚Äî not yet active");
    }

    // ----------------------------------------------------------------
    // Main session toggle ‚Äî Start / Stop
    // ----------------------------------------------------------------
    async function toggleSession() {
      if (isConnected) {
        stopSession();
      } else {
        await startSession();
      }
    }

    async function startSession() {
      const btn = document.getElementById("mainBtn");
      btn.disabled = true;
      setStatus("connecting", "Connecting to Vidya...");

      try {
        // ----------------------------------------------------------
        // Request a Daily room URL from our backend.
        // The backend (backend.py) creates a temporary Daily room
        // and returns its URL.
        // ----------------------------------------------------------
        const response = await fetch("/api/session/start", { method: "POST" });

        if (!response.ok) {
          throw new Error(`Backend error: ${response.status}`);
        }

        const data = await response.json();
        const roomUrl = data.room_url;

        if (!roomUrl) {
          throw new Error("No room URL returned from backend");
        }

        // ----------------------------------------------------------
        // Connect to the Daily room
        // ----------------------------------------------------------
        callObject = window.DailyIframe.createCallObject();

        callObject.on("joined-meeting", () => {
          isConnected = true;
          setStatus("connected", "Connected ‚Äî Vidya is listening...");
          btn.textContent = "üî¥  End Session";
          btn.className = "btn-start stop";
          btn.disabled = false;
          connectVisualChannel(data.session_id);
        });

        callObject.on("participant-updated", (event) => {
          // Show speaking/listening state based on audio activity
          if (event.participant.local) {
            if (event.participant.tracks?.audio?.state === "playable") {
              setStatus("listening", "Vidya is listening...");
            }
          }
        });

        callObject.on("track-started", (event) => {
          if (!event.participant.local) {
            setStatus("speaking", "Vidya is speaking...");
          }
        });

        callObject.on("track-stopped", (event) => {
          if (!event.participant.local) {
            setStatus("listening", "Vidya is listening...");
          }
        });

        callObject.on("left-meeting", () => {
          handleDisconnect();
        });

        callObject.on("error", (error) => {
          console.error("Daily error:", error);
          setStatus("error", "Connection error ‚Äî please refresh");
          handleDisconnect();
        });

        await callObject.join({ url: roomUrl });

      } catch (err) {
        console.error("Failed to start session:", err);
        setStatus("error", "Could not connect ‚Äî check your internet");
        btn.textContent = "üéôÔ∏è Start Learning with Vidya";
        btn.className = "btn-start start";
        btn.disabled = false;
      }
    }

    function stopSession() {
      if (callObject) {
        callObject.leave();
      }
    }

    function handleDisconnect() {
      isConnected = false;
      if (callObject) {
        callObject.destroy();
        callObject = null;
      }
      hideImage();
      setStatus("", "Session ended ‚Äî see you next time!");
      const btn = document.getElementById("mainBtn");
      btn.textContent = "üéôÔ∏è Start Learning with Vidya";
      btn.className = "btn-start start";
      btn.disabled = false;
    }
  </script>

</body>
</html>
